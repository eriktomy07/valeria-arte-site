---
import Layout from "../../layouts/Layout.astro";
import { obras } from "../../data/obras";

export async function getStaticPaths() {
  return obras.map((o) => ({ params: { id: o.id }, props: { obra: o } }));
}

const { obra } = Astro.props;
const precio = new Intl.NumberFormat("es-UY").format(obra.precioUYU || 0);

const esVendido = obra.estado?.toLowerCase() === "vendido";
const esReservado = obra.estado?.toLowerCase() === "reservado";

const colorBadge = esVendido
  ? "bg-rose-100 text-rose-700 border-rose-200"
  : esReservado
  ? "bg-amber-100 text-amber-700 border-amber-200"
  : "bg-emerald-100 text-emerald-700 border-emerald-200";

const WHATSAPP_NUMBER = "59894746670";
const wa = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(
  `Hola Valeria, me interesa la obra "${obra.titulo}".`
)}`;
const mail = `mailto:erikspangenberg.uy@gmail.com?subject=${encodeURIComponent(
  `Consulta obra ${obra.titulo}`
)}`;
---

<Layout title={`Obra • ${obra.titulo}`}>
  <nav class="mb-4">
    <a href="/" class="text-sm text-slate-600 hover:underline">← Volver</a>
  </nav>

  <div class="grid gap-8 md:grid-cols-2 items-start">
    <!-- Imagen con overlay “Ampliar” -->
    <div class="relative">
      <img
        src={obra.imagen}
        alt={`Obra ${obra.titulo}`}
        class="w-full rounded-2xl shadow-lg object-cover"
      />

      <button
        type="button"
        onclick={`openDialog('dlg-${obra.id}')`}
        class="group absolute bottom-4 right-4 inline-flex items-center gap-2 px-3 py-2 rounded-full
               bg-black/60 text-white backdrop-blur-sm hover:bg-black/70
               focus:outline-none focus-visible:ring-2 focus-visible:ring-white/80
               transition-colors"
        aria-label="Ampliar imagen"
        title="Ampliar"
      >
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-4 w-4">
          <path fill="currentColor"
            d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79L20 21.5 21.5 20l-6-6zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
        </svg>
        <span class="text-sm">Ampliar</span>
      </button>

      <span class={`absolute left-3 top-3 border text-xs px-2 py-1 rounded-full ${colorBadge}`}>
        {obra.estado}
      </span>
    </div>

    <!-- Ficha -->
    <section class="space-y-3">
      <h1 class="text-3xl font-semibold">{obra.titulo}</h1>
      <p class="text-slate-600">{obra.tecnica} • {obra.medidas} • {obra.ano}</p>
      <p class="font-medium">
        {esVendido ? "Vendido" : esReservado ? "Reservado" : `\$${precio} UYU`}
      </p>

      <div class="flex gap-2 pt-2">
        <a
          href={wa}
          target="_blank"
          rel="noreferrer"
          class={`inline-flex items-center justify-center px-4 py-2 rounded-full text-sm font-medium transition-colors
                  ${esVendido ? "bg-slate-200 text-slate-500 cursor-not-allowed" : "bg-blue-500 text-white hover:bg-blue-600"}`}
          aria-disabled={esVendido}
          onclick={esVendido ? 'event.preventDefault()' : undefined}
        >
          {esVendido ? "No disponible" : "Consultar"}
        </a>
        <a
          href={mail}
          class="inline-flex items-center justify-center px-4 py-2 rounded-full text-sm font-medium
                 border border-slate-200 text-slate-800 hover:bg-slate-50"
        >
          Email
        </a>
      </div>
    </section>
  </div>

  <!-- MODAL centrado -->
  <dialog
    id={`dlg-${obra.id}`}
    class="relative p-0 border-0 rounded-2xl grid place-items-center
           backdrop:bg-black/60 backdrop:backdrop-blur-sm"
  >
    <form method="dialog">
      <button class="absolute right-3 top-3 z-10 bg-white/90 rounded-full px-3 py-1 text-sm border">
        Cerrar
      </button>
    </form>

    <img
      src={obra.imagen}
      alt={`Obra ${obra.titulo} ampliada`}
      class="max-w-[90vw] max-h-[85vh] object-contain block"
    />
  </dialog>
</Layout>